{#include base}
{#title}Security Recommendations - PostgreSQL Console{/title}

<div id="refreshable-content" hx-get="/security/recommendations?instance={currentInstance ?: 'default'}" hx-trigger="refresh" hx-swap="innerHTML" hx-select="#refreshable-content > *">

<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/security?instance={currentInstance}">Security</a></li>
                <li class="breadcrumb-item active">Recommendations</li>
            </ol>
        </nav>
        <h1><i class="bi bi-lightbulb me-2"></i>Security Recommendations</h1>
        <p class="text-muted">Actionable improvements based on security analysis</p>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 border-0 shadow-sm border-start border-4 border-danger">
            <div class="card-body text-center">
                <span class="badge bg-danger mb-2">Critical</span>
                <h2 class="mb-0">{summary.criticalCount}</h2>
                <small class="text-muted">immediate action required</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 border-0 shadow-sm border-start border-4 border-warning">
            <div class="card-body text-center">
                <span class="badge bg-warning text-dark mb-2">High</span>
                <h2 class="mb-0">{summary.highCount}</h2>
                <small class="text-muted">should address soon</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 border-0 shadow-sm border-start border-4 border-info">
            <div class="card-body text-center">
                <span class="badge bg-info mb-2">Medium</span>
                <h2 class="mb-0">{summary.mediumCount}</h2>
                <small class="text-muted">plan to address</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card h-100 border-0 shadow-sm border-start border-4 border-secondary">
            <div class="card-body text-center">
                <span class="badge bg-secondary mb-2">Low</span>
                <h2 class="mb-0">{summary.lowCount}</h2>
                <small class="text-muted">consider when possible</small>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations by Priority -->
{#if recommendations.isEmpty()}
<div class="row mb-4">
    <div class="col">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-shield-check fs-1 text-success mb-3 d-block"></i>
                <h4 class="text-success">Excellent Security Posture</h4>
                <p class="text-muted mb-0">No security recommendations at this time. Your database configuration follows best practices.</p>
            </div>
        </div>
    </div>
</div>
{#else}

<!-- Critical Recommendations -->
{#set criticalRecs = recommendations.stream().filter(r -> r.priority.displayName == 'Critical').toList()}
{#if !criticalRecs.isEmpty()}
<div class="row mb-4">
    <div class="col">
        <div class="card border-0 shadow-sm border-start border-4 border-danger">
            <div class="card-header bg-danger bg-opacity-10 border-0">
                <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-octagon me-2"></i>Critical Issues ({criticalRecs.size})</h5>
            </div>
            <div class="card-body p-0">
                {#for rec in criticalRecs}
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-danger me-3">Critical</span>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="bi {rec.categoryIconClass} me-1 text-muted"></i>
                                {rec.title}
                            </h6>
                            <p class="mb-2">{rec.description}</p>
                            {#if rec.rationale}
                            <p class="text-muted small mb-2"><strong>Why:</strong> {rec.rationale}</p>
                            {/if}
                            <p class="mb-0"><strong>Action:</strong> <code>{rec.suggestedAction}</code></p>
                            {#if rec.hasValueComparison}
                            <p class="small text-muted mb-0 mt-1">
                                Current: <code>{rec.currentValue}</code> → Recommended: <code>{rec.recommendedValue}</code>
                            </p>
                            {/if}
                        </div>
                    </div>
                </div>
                {/for}
            </div>
        </div>
    </div>
</div>
{/if}

<!-- High Priority Recommendations -->
{#set highRecs = recommendations.stream().filter(r -> r.priority.displayName == 'High').toList()}
{#if !highRecs.isEmpty()}
<div class="row mb-4">
    <div class="col">
        <div class="card border-0 shadow-sm border-start border-4 border-warning">
            <div class="card-header bg-warning bg-opacity-10 border-0">
                <h5 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>High Priority ({highRecs.size})</h5>
            </div>
            <div class="card-body p-0">
                {#for rec in highRecs}
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-warning text-dark me-3">High</span>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="bi {rec.categoryIconClass} me-1 text-muted"></i>
                                {rec.title}
                            </h6>
                            <p class="mb-2">{rec.description}</p>
                            {#if rec.rationale}
                            <p class="text-muted small mb-2"><strong>Why:</strong> {rec.rationale}</p>
                            {/if}
                            <p class="mb-0"><strong>Action:</strong> <code>{rec.suggestedAction}</code></p>
                            {#if rec.hasValueComparison}
                            <p class="small text-muted mb-0 mt-1">
                                Current: <code>{rec.currentValue}</code> → Recommended: <code>{rec.recommendedValue}</code>
                            </p>
                            {/if}
                        </div>
                    </div>
                </div>
                {/for}
            </div>
        </div>
    </div>
</div>
{/if}

<!-- Medium Priority Recommendations -->
{#set mediumRecs = recommendations.stream().filter(r -> r.priority.displayName == 'Medium').toList()}
{#if !mediumRecs.isEmpty()}
<div class="row mb-4">
    <div class="col">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info bg-opacity-10 border-0">
                <h5 class="mb-0 text-info"><i class="bi bi-info-circle me-2"></i>Medium Priority ({mediumRecs.size})</h5>
            </div>
            <div class="card-body p-0">
                {#for rec in mediumRecs}
                <div class="p-3 border-bottom">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-info me-3">Medium</span>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="bi {rec.categoryIconClass} me-1 text-muted"></i>
                                {rec.title}
                            </h6>
                            <p class="mb-2">{rec.description}</p>
                            <p class="mb-0"><strong>Action:</strong> <code>{rec.suggestedAction}</code></p>
                            {#if rec.hasValueComparison}
                            <p class="small text-muted mb-0 mt-1">
                                Current: <code>{rec.currentValue}</code> → Recommended: <code>{rec.recommendedValue}</code>
                            </p>
                            {/if}
                        </div>
                    </div>
                </div>
                {/for}
            </div>
        </div>
    </div>
</div>
{/if}

<!-- Low Priority & Informational -->
{#set lowRecs = recommendations.stream().filter(r -> r.priority.displayName == 'Low' || r.priority.displayName == 'Info').toList()}
{#if !lowRecs.isEmpty()}
<div class="row mb-4">
    <div class="col">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Low Priority & Informational ({lowRecs.size})</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Priority</th>
                                <th style="width: 120px;">Category</th>
                                <th>Recommendation</th>
                                <th>Suggested Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {#for rec in lowRecs}
                            <tr>
                                <td><span class="badge {rec.priorityCssClass}">{rec.priorityDisplay}</span></td>
                                <td><i class="bi {rec.categoryIconClass} me-1"></i>{rec.categoryDisplay}</td>
                                <td>
                                    <strong>{rec.title}</strong>
                                    <br><small class="text-muted">{rec.description}</small>
                                </td>
                                <td><code class="small">{rec.suggestedAction}</code></td>
                            </tr>
                            {/for}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{/if}

{/if}

<!-- Legend -->
<div class="row">
    <div class="col">
        <div class="card border-0 bg-light">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-question-circle me-2"></i>Priority Levels</h6>
                <div class="row">
                    <div class="col-md-3">
                        <span class="badge bg-danger me-2">Critical</span>
                        <small class="text-muted">Security vulnerabilities requiring immediate attention</small>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-warning text-dark me-2">High</span>
                        <small class="text-muted">Important issues that should be addressed soon</small>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-info me-2">Medium</span>
                        <small class="text-muted">Improvements to plan into upcoming work</small>
                    </div>
                    <div class="col-md-3">
                        <span class="badge bg-secondary me-2">Low</span>
                        <small class="text-muted">Best practices to consider when convenient</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
{/include}
