{#include base}
{#title}Intelligent Insights - PostgreSQL Console{/title}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <i class="bi bi-lightbulb text-warning me-2" aria-hidden="true"></i>
            Intelligent Insights
        </h1>
        <p class="text-muted mb-0">AI-powered analysis, anomaly detection, and recommendations</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" hx-post="/insights/refresh?instance={instance}" hx-swap="none"
                hx-on::after-request="location.reload()">
            <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i>
            Refresh Insights
        </button>
    </div>
</div>

<!-- Health Score Card -->
<div class="row mb-4">
    <div class="col-lg-4 mb-3 mb-lg-0">
        <div class="card h-100">
            <div class="card-body text-center">
                <h5 class="card-title text-muted mb-3">Overall Health Score</h5>
                <div class="display-1 fw-bold {#if summary.overallHealthScore >= 80}text-success{#else if summary.overallHealthScore >= 60}text-warning{#else}text-danger{/if}">
                    {summary.overallHealthScore}
                </div>
                <p class="text-muted mt-2">
                    {#if summary.overallHealthScore >= 80}
                    <i class="bi bi-check-circle-fill text-success" aria-hidden="true"></i> Healthy
                    {#else if summary.overallHealthScore >= 60}
                    <i class="bi bi-exclamation-triangle-fill text-warning" aria-hidden="true"></i> Needs Attention
                    {#else}
                    <i class="bi bi-x-circle-fill text-danger" aria-hidden="true"></i> Critical Issues
                    {/if}
                </p>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-exclamation-diamond me-2" aria-hidden="true"></i>
                Top Concerns
            </div>
            <div class="card-body">
                {#if summary.topConcerns.isEmpty}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-check-circle-fill display-4 text-success" aria-hidden="true"></i>
                    <p class="mt-2 mb-0">No critical concerns detected</p>
                </div>
                {#else}
                <div class="list-group list-group-flush">
                    {#for concern in summary.topConcerns}
                    <a href="{concern.actionUrl}?instance={instance}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{concern.title}</div>
                            <small class="text-muted">{concern.description}</small>
                        </div>
                        <span class="badge {#if concern.severity.name == 'CRITICAL'}bg-danger{#else if concern.severity.name == 'HIGH'}bg-warning text-dark{#else if concern.severity.name == 'MEDIUM'}bg-info{#else}bg-secondary{/if}">
                            {concern.severity}
                        </span>
                    </a>
                    {/for}
                </div>
                {/if}
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row -->
<div class="row mb-4">
    <div class="col-md-6 col-lg-3 mb-3 mb-lg-0">
        <a href="/insights/anomalies?instance={instance}" class="text-decoration-none">
            <div class="card h-100 hover-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-danger bg-opacity-10 p-3 rounded">
                                <i class="bi bi-graph-up-arrow text-danger fs-3" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Anomalies</h6>
                            <h3 class="mb-0">
                                {summary.anomalyCountCritical + summary.anomalyCountHigh + summary.anomalyCountMedium + summary.anomalyCountLow}
                            </h3>
                            <small class="text-muted">
                                {#if summary.anomalyCountCritical > 0}<span class="text-danger">{summary.anomalyCountCritical} critical</span>{/if}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-lg-3 mb-3 mb-lg-0">
        <a href="/insights/recommendations?instance={instance}" class="text-decoration-none">
            <div class="card h-100 hover-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="bi bi-lightbulb text-warning fs-3" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Recommendations</h6>
                            <h3 class="mb-0">
                                {summary.recommendationCountCritical + summary.recommendationCountHigh + summary.recommendationCountMedium + summary.recommendationCountLow}
                            </h3>
                            <small class="text-muted">
                                {#if summary.recommendationCountHigh > 0}<span class="text-warning">{summary.recommendationCountHigh} high priority</span>{/if}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-lg-3 mb-3 mb-lg-0">
        <a href="/insights/forecasts?instance={instance}" class="text-decoration-none">
            <div class="card h-100 hover-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <i class="bi bi-graph-up text-primary fs-3" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Storage Forecast</h6>
                            <h3 class="mb-0">
                                {#if summary.storageDaysUntilWarning != null}
                                {summary.storageDaysUntilWarning}d
                                {#else}
                                -
                                {/if}
                            </h3>
                            <small class="text-muted">until warning threshold</small>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-lg-3">
        <a href="/insights/runbooks?instance={instance}" class="text-decoration-none">
            <div class="card h-100 hover-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <i class="bi bi-journal-code text-success fs-3" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-1">Runbooks</h6>
                            <h3 class="mb-0">{suggestedRunbooks.size}</h3>
                            <small class="text-muted">suggested actions</small>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Natural Language Query Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-chat-dots me-2" aria-hidden="true"></i>
                Ask a Question
            </div>
            <div class="card-body">
                <form id="nlQueryForm" hx-post="/insights/ask?instance={instance}" hx-target="#queryResult"
                      hx-indicator="#queryLoading">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg" name="query"
                               placeholder="e.g. 'Why is the database slow?' or 'Show me slow queries from yesterday'"
                               aria-label="Natural language query">
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search me-1" aria-hidden="true"></i>
                            Ask
                        </button>
                    </div>
                </form>
                <div id="queryLoading" class="htmx-indicator text-center py-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Analysing your question...</span>
                </div>
                <div id="queryResult"></div>
                <div class="mt-3">
                    <small class="text-muted">Try:</small>
                    {#for query in suggestedQueries}
                    <button class="btn btn-sm btn-outline-secondary me-1 mb-1" type="button"
                            onclick="document.querySelector('#nlQueryForm input[name=query]').value = '{query}'; htmx.trigger('#nlQueryForm', 'submit');">
                        {query}
                    </button>
                    {/for}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Two Column Layout -->
<div class="row">
    <!-- Top Recommendations -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-lightbulb me-2" aria-hidden="true"></i>
                    Top Recommendations
                </span>
                <a href="/insights/recommendations?instance={instance}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body p-0">
                {#if topRecommendations.isEmpty}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle display-4" aria-hidden="true"></i>
                    <p class="mt-2 mb-0">No recommendations at this time</p>
                </div>
                {#else}
                <div class="list-group list-group-flush">
                    {#for rec in topRecommendations}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{rec.title}</h6>
                                <p class="mb-1 text-muted small">{rec.description}</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-secondary">{rec.source}</span>
                                    <span class="badge {#if rec.estimatedImpact != null && rec.estimatedImpact.name == 'HIGH'}bg-danger{#else if rec.estimatedImpact != null && rec.estimatedImpact.name == 'MEDIUM'}bg-warning text-dark{#else}bg-info{/if}">
                                        {rec.estimatedImpact ?: 'N/A'} impact
                                    </span>
                                </div>
                            </div>
                            <span class="badge {#if rec.severity.name == 'CRITICAL'}bg-danger{#else if rec.severity.name == 'HIGH'}bg-warning text-dark{#else if rec.severity.name == 'MEDIUM'}bg-info{#else}bg-secondary{/if}">
                                {rec.severity}
                            </span>
                        </div>
                    </div>
                    {/for}
                </div>
                {/if}
            </div>
        </div>
    </div>

    <!-- Open Anomalies -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
                    Open Anomalies
                </span>
                <a href="/insights/anomalies?instance={instance}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body p-0">
                {#if openAnomalies.isEmpty}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle display-4 text-success" aria-hidden="true"></i>
                    <p class="mt-2 mb-0">No active anomalies detected</p>
                </div>
                {#else}
                <div class="list-group list-group-flush">
                    {#for anomaly in openAnomalies}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    {#if anomaly.direction.name == 'ABOVE'}
                                    <i class="bi bi-arrow-up-circle text-danger" aria-hidden="true"></i>
                                    {#else}
                                    <i class="bi bi-arrow-down-circle text-warning" aria-hidden="true"></i>
                                    {/if}
                                    {anomaly.metricName}
                                </h6>
                                <p class="mb-1 text-muted small">{anomaly.rootCauseSuggestion}</p>
                                <small class="text-muted">
                                    Detected {anomaly.detectedAt}
                                </small>
                            </div>
                            <span class="badge {#if anomaly.severity.name == 'CRITICAL'}bg-danger{#else if anomaly.severity.name == 'HIGH'}bg-warning text-dark{#else if anomaly.severity.name == 'MEDIUM'}bg-info{#else}bg-secondary{/if}">
                                {anomaly.severity}
                            </span>
                        </div>
                    </div>
                    {/for}
                </div>
                {/if}
            </div>
        </div>
    </div>
</div>

<!-- Suggested Runbooks -->
{#if !suggestedRunbooks.isEmpty}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-journal-code me-2" aria-hidden="true"></i>
                Suggested Runbooks
            </div>
            <div class="card-body">
                <div class="row">
                    {#for runbook in suggestedRunbooks}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">{runbook.name}</h6>
                                <p class="card-text small text-muted">{runbook.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-secondary">{runbook.category}</span>
                                    <button class="btn btn-sm btn-outline-primary"
                                            hx-post="/insights/runbooks/{runbook.id}/start?instance={instance}"
                                            hx-swap="none"
                                            hx-on::after-request="if(event.detail.xhr.status === 200) { const resp = JSON.parse(event.detail.xhr.responseText); window.location.href = resp.redirectUrl; }">
                                        <i class="bi bi-play-fill" aria-hidden="true"></i>
                                        Start
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {/for}
                </div>
            </div>
        </div>
    </div>
</div>
{/if}

<style>
    .hover-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
</style>

<script>
    // Handle NL query response
    document.body.addEventListener('htmx:afterSwap', function(event) \{
        if (event.detail.target.id === 'queryResult') \{
            try \{
                const response = JSON.parse(event.detail.xhr.responseText);
                const resultDiv = document.getElementById('queryResult');

                if (response.understood) \{
                    resultDiv.innerHTML = '<div class="alert alert-success">' +
                        '<h6 class="alert-heading">' +
                            '<i class="bi bi-check-circle me-2"></i>' +
                            'Understood: ' + response.intent +
                        '</h6>' +
                        '<p class="mb-2">' + response.explanation + '</p>' +
                        '<a href="' + response.redirectUrl + '" class="btn btn-sm btn-success">' +
                            '<i class="bi bi-arrow-right me-1"></i>' +
                            'Go to Results' +
                        '</a>' +
                        '<small class="text-muted ms-2">Confidence: ' + Math.round(response.confidence * 100) + '%</small>' +
                    '</div>';
                \} else \{
                    resultDiv.innerHTML = '<div class="alert alert-warning">' +
                        '<h6 class="alert-heading">' +
                            '<i class="bi bi-question-circle me-2"></i>' +
                            'Could not understand query' +
                        '</h6>' +
                        '<p class="mb-0">' + (response.explanation || 'Try rephrasing your question or use one of the suggested queries above.') + '</p>' +
                    '</div>';
                \}
            \} catch (e) \{
                // Not JSON, might be HTML
            \}
        \}
    \});
</script>

{/include}
