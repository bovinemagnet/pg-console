{#include base}
{#title}Slow Queries - PostgreSQL Console{/title}

<div id="refreshable-content" hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy={sortBy}&order={order}" hx-trigger="refresh" hx-swap="innerHTML" hx-select="#refreshable-content > *">

<div class="row mb-4">
    <div class="col">
        <h1>Slow Queries</h1>
        <p class="text-muted">Data from pg_stat_statements extension</p>
    </div>
    <div class="col-auto">
        <a href="/slow-queries/export?instance={currentInstance ?: 'default'}&sortBy={sortBy}&order={order}"
           class="btn btn-outline-secondary">
            ðŸ“¥ Export CSV
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        {#if queries.isEmpty()}
        <div class="alert alert-warning">
            <strong>No data available.</strong> The pg_stat_statements extension may not be installed or enabled.
            <br><small>Enable it with: <code>CREATE EXTENSION pg_stat_statements;</code></small>
        </div>
        {#else}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=query&order={#if sortBy == 'query' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Query
                            {#if sortBy == 'query'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=calls&order={#if sortBy == 'calls' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Calls
                            {#if sortBy == 'calls'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=totalTime&order={#if sortBy == 'totalTime' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Total Time
                            {#if sortBy == 'totalTime'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=meanTime&order={#if sortBy == 'meanTime' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Mean Time
                            {#if sortBy == 'meanTime'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=maxTime&order={#if sortBy == 'maxTime' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Max Time
                            {#if sortBy == 'maxTime'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th class="sortable"
                            hx-get="/slow-queries?instance={currentInstance ?: 'default'}&sortBy=rows&order={#if sortBy == 'rows' && order == 'asc'}desc{#else}asc{/if}"
                            hx-target="body"
                            hx-swap="innerHTML">
                            Rows
                            {#if sortBy == 'rows'}
                                <span class="sort-indicator">{#if order == 'asc'}â–²{#else}â–¼{/if}</span>
                            {/if}
                        </th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {#for query in queries}
                    <tr>
                        <td class="query-preview">
                            {query.shortQuery}
                            <div class="query-full">{query.query}</div>
                        </td>
                        <td>{query.totalCalls}</td>
                        <td>{query.totalTimeFormatted}</td>
                        <td>{query.meanTimeFormatted}</td>
                        <td>{query.maxTimeFormatted}</td>
                        <td>{query.rows}</td>
                        <td>
                            <a href="/slow-queries/{query.queryId}?instance={currentInstance ?: 'default'}" class="btn btn-sm btn-outline-primary">Details</a>
                        </td>
                    </tr>
                    {/for}
                </tbody>
            </table>
        </div>
        {/if}
    </div>
</div>

</div>

{/include}
