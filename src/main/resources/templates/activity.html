{#include base}
{#title}Current Activity - PostgreSQL Console{/title}

<div id="refreshable-content" hx-get="/activity" hx-trigger="refresh" hx-swap="innerHTML" hx-select="#refreshable-content > *">

<div class="row mb-4">
    <div class="col">
        <h1>Current Activity</h1>
        <p class="text-muted">Active connections and running queries</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        {#if activities.isEmpty()}
        <div class="alert alert-info">
            No active queries at the moment.
        </div>
        {#else}
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th>PID</th>
                        <th>User</th>
                        <th>Database</th>
                        <th>App</th>
                        <th>State</th>
                        <th>Wait Event</th>
                        <th>Query Start</th>
                        <th>Query</th>
                        <th>Blocking</th>
                    </tr>
                </thead>
                <tbody>
                    {#for act in activities}
                    <tr {#if act.blockingPid}class="table-danger"{/if}>
                        <td>{act.pid}</td>
                        <td>{act.user}</td>
                        <td>{act.database}</td>
                        <td>{act.applicationName}</td>
                        <td>
                            <span class="badge
                                {#if act.state == 'active'}bg-success
                                {#else if act.state == 'idle in transaction'}bg-warning text-dark
                                {#else}bg-secondary{/if}">
                                {act.state}
                            </span>
                        </td>
                        <td>
                            {#if act.waitEventType}
                                <small>{act.waitEventType}: {act.waitEvent}</small>
                            {#else}
                                -
                            {/if}
                        </td>
                        <td>{#if act.queryStart}{act.queryStart}{#else}-{/if}</td>
                        <td class="query-preview">
                            {act.shortQuery}
                            <div class="query-full">{act.query}</div>
                        </td>
                        <td>
                            {#if act.blockingPid}
                                <a href="/locks" class="blocking">⚠️ {act.blockingPid}</a>
                            {#else}
                                -
                            {/if}
                        </td>
                    </tr>
                    {/for}
                </tbody>
            </table>
        </div>
        {/if}
    </div>
</div>

</div>

{/include}
